{% extends 'base.html' %} 
{% block title %}Cart | {% endblock %} 


{% block content %}
	<div id="cartapp">
		<h1 class="title">Cart</h1>
		{% if cart %}
			<div v-if="products.length > 0">
				<div class="table">
			        <table class="table">
			            <thead>
			                <th>Product</th>
			                <th>Quantity</th>
			                <th>Price</th>
			                <th>Delete</th>
			            </thead>
			            <tbody>
			            	<tr v-for="product in products">
			            		<td>[[ product.title ]]</td>
			            		<td>
			            			<button @click="decrementQuantity(product.id, product.quantity, product.price)">-</button>
			            			[[ product.quantity ]]
			            			<button @click="incrementQuantity(product.id, product.quantity, product.price)">+</button>
			            		</td>
	                    		<td>[[ product.total_price ]]</td>
	                    		<td>
			                    	<button @click="removeFromCart(product.id)">Remove from cart</button>
			                    </td>
			            	</tr>
			            </tbody>
			            <tfoot>
			            	<td>Total cost:</td>
			            	<td>[[ numItems ]]</td>
			            	<td></td>
			            	<td>[[ totalCost ]]</td>
			            </tfoot>
		        	</table>
		    	</div>
		    	<form v-on:submit.prevent="submitForm()">
		    		<div class="field">
		    			<div class="control">
		    				<label>First name</label>
		    				<input type="text" name="first_name" v-model="first_name">
		    			</div>
		    		</div>
		    		<div class="field">
		    			<div class="control">
		    				<label>Last name</label>
		    				<input type="text" name="last_name" v-model="last_name">
		    			</div>
		    		</div>
		    		<div class="field">
		    			<div class="control">
		    				<label>Email</label>
		    				<input type="text" name="email" v-model="email">
		    			</div>
		    		</div>
		    		<div class="field">
		    			<div class="control">
		    				<label>Address</label>
		    				<input type="text" name="address" v-model="address">
		    			</div>
		    		</div>
		    		<div class="field">
		    			<div class="control">
		    				<label>Zip code</label>
		    				<input type="text" name="zipcode" v-model="zipcode">
		    			</div>
		    		</div>
		    		<div class="field">
		    			<div class="control">
		    				<label>Place</label>
		    				<input type="text" name="place" v-model="place">
		    			</div>
		    		</div>
		    		<div class="field">
		    			<div class="control">
		    				<button class="button is-primary">Check out</button>
		    			</div>
		    		</div>
		    	</form>
		    </div>
		    <p v-else>Your cart is empty!</p>
		{% else %}
	    	<p>Your cart is empty</p>
	    {% endif %}
    </div>
{% endblock %}



{% block scripts %}
<script>
    var cartVue = new Vue({
        el: '#cartapp',
        delimiters: ['[[', ']]'],
        store: store,
        data () {
            return {
            	first_name: '',
            	last_name: '',
            	email: '',
            	address: '',
            	zipcode:'',
            	place: '',
            	products: [{{ productsstring|safe }}],
            }
        },
        computed: {
            numItems: function() {
                return store.state.numItems
            },
            numItems: function() {
                return store.state.totalCost
            }
        },
        methods: {
        	submitForm() {
            	console.log("YES")
            	var data = {
            		'first_name': this.first_name, 
            		'last_name': this.last_name, 
            		'email': this.email, 
            		'address': this.address, 
            		'zipcode': this.zipcode, 
            		'place': this.place, 
            	}
            	fetch('/api/checkout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                }).then((response) => {
                    console.log("Success");
                    console.log(response);
                    window.location.href="/";
                }).catch(function(error) {
                    console.log('Error 2');
                    console.log(error); 
                })
            },
        	// INCREMENT PRODUCT QUANTITY IN THE CART
        	incrementQuantity(product_id, quantity, price) {
                console.log('product_id: ', product_id);
                var data = {
                    'product_id': product_id,
                    'quantity': parseInt(quantity) + 1,
                    'update': true
                }
                store.commit('increment', 1);
                store.commit('changeTotalCost', parseFloat(price));
                fetch('/api/add_to_cart/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                }).then((response) => {
                    console.log(response);
                    for (var i = 0; i < this.products.length; i++) {
                    	var product = this.products[i];
                    	if (product.id == product_id) {
                    		this.products[i].quantity = parseInt(this.products[i].quantity) +1;
                    		this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price);
                    	}
                    }
                }).catch(function(error) {
                    console.log('Error 2');
                    console.log(error);
                })
            },
            // DECREMENT PRODUCT QUANTITY IN THE CART
        	decrementQuantity(product_id, quantity) {
                console.log('product_id: ', product_id, price);
                var data = {
                    'product_id': product_id,
                    'quantity': parseInt(quantity) - 1,
                    'update': true
                };
                if (parseInt(quantity) -1 === 0) {
                	this.removeFromCart(product_id);
                } else {
                	store.commit('increment', -1);
                	store.commit('changeTotalCost', -parseFloat(price));
                
	                fetch('/api/add_to_cart/', {
	                    method: 'POST',
	                    headers: {
	                        'Content-Type': 'application/json',
	                        'X-CSRFToken': '{{ csrf_token }}'
	                    },
	                    credentials: 'same-origin',
	                    body: JSON.stringify(data)
	                }).then((response) => {
	                    console.log(response);
	                    for (var i = 0; i < this.products.length; i++) {
	                    	var product = this.products[i];
	                    	if (product.id == product_id) {
	                    		this.products[i].quantity = parseInt(this.products[i].quantity) -1;
	                    		this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price);
	                    	}
	                    }
	                }).catch(function(error) {
	                    console.log('Error 2');
	                    console.log(error);
	                })
	            }
            },

            // REMOVE PRODUCT IN THE CART
            removeFromCart(product_id) {
                console.log('product_id: ', product_id);
                var data = {
                    'product_id': product_id
                }
                fetch('/api/remove_from_cart/', {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                }).then((response) => {
                    console.log(response);
                    this.products = this.products.filter(product => product.id !== product_id)
                }).catch(function(error) {
                    console.log('Error 2');
                    console.log(error);
                })
            },
        },
    })
</script>

{% endblock %}